#! /usr/bin/env bash

export bashum_cmd=${bashum_cmd:-bashum}
export bashum_home=${bashum_home:-$HOME/.bashum}
export bashum_repo=${bashum_repo:-$HOME/.bashum_repo}
export bashum_tmp_dir=${bashum_tmp_dir:-/tmp/bashum/}
export bashum_version="1.0.0"

source $bashum_home/lib/require.sh

set -o errexit 
set -o errtrace 

require 'lib/console.sh'

# ensure all the required directories are there.
[[ -d $bashum_repo ]]          || mkdir -p $bashum_repo
[[ -d $bashum_repo/packages ]] || mkdir -p $bashum_repo/packages
[[ -d $bashum_repo/bin ]]      || mkdir -p $bashum_repo/bin

# make a tmp directory as a sandbox
[[ ! -d $bashum_tmp_dir ]]     || rm -r $bashum_tmp_dir

mkdir -p $bashum_tmp_dir

# cleanup on exit.
on_exit() {
	rm -r $bashum_tmp_dir
} 

trap "on_exit" EXIT

bashum_help() {
	bold "BASHUM HELP"
	echo 

	printf "%s\n" '
	Bashum is a package manager for bash projects.  It provides support
	for building, installing, and maintaining .bashum files.  
'

	bold "COMMANDS"
	echo

	for command in $bashum_home/commands/*.sh
	do
		source $command

		cmd=$(basename $command)
		cmd=${cmd/.sh/}

		printf "\t"; "$cmd"_usage "$@" 
	done
	echo 

	bold 'MORE INFO'
	printf "%s\n" '
	To get more detailed help, simply type bashum <command> help [--detailed]

'
}

bashum_version() {
	bold "BASHUM VERSION"

	printf "%s\n" "
	$bashum_version
"
}

args=( "${@}" )
action="${args[0]}"

if [[ -z $action ]] 
then
	bashum_help
	exit $?
fi
shift

if [[ ! -f $bashum_home/commands/"$action".sh ]]
then
	case "$action" in
		help|-h|--help)
			bashum_help 
			;;
		version|-v|--version)
			bashum_version
			;;
		*)
			error "That sub-command is not supported."
			echo
			bashum_help
			;;
	esac

	exit $?
fi

require "commands/$action.sh"
$action "$@"
exit $?
